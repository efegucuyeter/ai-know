<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        body {
            background: #578FCA;
            background: radial-gradient(circle, rgba(87, 143, 202, 1) 53%, rgba(148, 187, 233, 1) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .main-content {
            flex: 1;
            padding-bottom: 100px;
        }
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .nav-link {
            color: #3674B5 !important;
            font-weight: 600;
        }
        .navbar-toggler {
            border-color: #3674B5;
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%233674B5' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        .nav-link.active {
            color: #2c5d95 !important;
            background: rgba(54, 116, 181, 0.1);
            border-radius: 8px;
        }
        .page-title {
            color: white;
            text-align: center;
            margin: 40px 0;
            font-weight: bold;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .section-title {
            color: white;
            margin: 30px 0 20px 0;
            font-weight: bold;
            font-size: 2rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            padding-left: 15px;
            border-left: 5px solid white;
        }
        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            padding: 40px;
            color: #2c5d95;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        .profile-avatar-container {
            position: relative;
            margin-right: 30px;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #3674B5;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-avatar:hover {
            opacity: 0.8;
        }
        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
        }
        .profile-avatar-container:hover .avatar-upload-overlay {
            opacity: 1;
        }
        .profile-info h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3674B5;
        }
        .profile-info p {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #666;
        }
        .profile-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(54, 116, 181, 0.1);
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            min-width: 150px;
            text-align: center;
            border: 1px solid rgba(54, 116, 181, 0.2);
        }
        .stat-card h4 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            color: #3674B5;
            font-weight: bold;
        }
        .stat-card p {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0;
            font-weight: 500;
        }
        .profile-details {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .details-box {
            flex: 1;
            min-width: 300px;
        }
        .detail-item {
            margin-bottom: 15px;
        }
        .detail-item label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .detail-item p {
            background: rgba(54, 116, 181, 0.1);
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 0;
            color: #2c5d95;
            border: 1px solid rgba(54, 116, 181, 0.2);
        }
        .btn-edit {
            background: linear-gradient(135deg, #3674B5, #2c5d95);
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            padding: 12px 30px;
            margin-top: 20px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(54, 116, 181, 0.3);
        }
        .btn-edit:hover {
            background: linear-gradient(135deg, #2c5d95, #1e4a73);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(54, 116, 181, 0.4);
        }
        .badge-custom {
            background: linear-gradient(135deg, #3674B5, #2c5d95);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
            display: inline-block;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(54, 116, 181, 0.2);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 50px 0 30px 0;
        }
        .section-header h3 {
            color: white;
            font-weight: bold;
            font-size: 2rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            padding-left: 15px;
            border-left: 5px solid white;
            margin: 0;
        }
        .view-all {
            background: rgba(255, 255, 255, 0.9);
            color: #3674B5;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .view-all:hover {
            background: white;
            color: #2c5d95;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            color: #2c5d95;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .activity-title {
            font-weight: bold;
            font-size: 1.2rem;
        }
        .activity-date {
            font-size: 0.85rem;
            color: #e0e0e0;
        }
        .activity-content {
            display: flex;
            align-items: center;
        }
        .activity-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }
        .activity-details {
            flex: 1;
        }
        .activity-details p {
            margin-bottom: 5px;
        }
        .activity-score {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .trophy-item {
            display: flex;
            align-items: center;
            background: rgba(0, 51, 102, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .trophy-icon {
            font-size: 2rem;
            color: gold;
            margin-right: 15px;
        }
        .trophy-info {
            flex: 1;
        }
        .trophy-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .trophy-desc {
            font-size: 0.9rem;
            color: #e0e0e0;
        }
        .trophy-date {
            font-size: 0.85rem;
            color: #e0e0e0;
            align-self: start;
        }
        footer {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            color: #3674B5;
            padding: 30px 0;
            margin-top: auto;
            width: 100%;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        .footer-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 25px;
        }
        .footer-box {
            background: rgba(54, 116, 181, 0.1);
            padding: 20px;
            border-radius: 15px;
            flex: 1;
            min-width: 200px;
            text-align: center;
            border: 1px solid rgba(54, 116, 181, 0.2);
        }
        .footer-box h5 {
            color: #3674B5;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .footer-box p {
            color: #666;
            margin-bottom: 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .footer-links {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(54, 116, 181, 0.2);
        }
        .footer-links p {
            margin-bottom: 10px;
            color: #666;
        }
        .footer-links a {
            color: #3674B5;
            text-decoration: none;
            margin: 0 10px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .footer-links a:hover {
            color: #2c5d95;
            text-decoration: underline;
        }
        .achievement-progress {
            height: 10px;
            margin-top: 5px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar-custom {
            height: 100%;
            background-color: #3674B5;
        }
        .quiz-card {
            background: rgba(0, 51, 102, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            cursor: pointer;
        }
        .quiz-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .quiz-image {
            height: 140px;
            overflow: hidden;
            position: relative;
        }
        .quiz-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .quiz-content {
            padding: 15px;
            color: white;
        }
        .quiz-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.3;
            height: 2.8rem;
            overflow: hidden;
        }
        .quiz-info {
            font-size: 0.8rem;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .difficulty {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #3674B5;
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        .question-count {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        .tab-pane {
            margin-top: 20px;
        }
        .nav-pills .nav-link {
            color: white;
            background-color: rgba(0, 51, 102, 0.2);
            border-radius: 30px;
            margin-right: 10px;
            padding: 8px 20px;
            margin-bottom: 10px;
        }
        .nav-pills .nav-link.active {
            background-color: #3674B5;
            color: white;
        }
        .quiz-form {
            background: rgba(0, 51, 102, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
        }
        .form-control, .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            margin-bottom: 15px;
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: #3674B5;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(54, 116, 181, 0.25);
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .form-select option {
            background-color: #2c5d95;
            color: white;
        }
        .question-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .option-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .option-input input[type="text"] {
            flex: 1;
            margin-right: 10px;
            margin-bottom: 0;
        }
        .option-input input[type="radio"] {
            margin-right: 10px;
        }
        .btn-add {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-right: 10px;
        }
        .btn-remove {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
        }
        .btn-create-quiz {
            background-color: #3674B5;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .btn-create-quiz:hover {
            background-color: #2c5d95;
        }
        .quiz-description {
            font-size: 0.9rem;
            color: black;
            margin-bottom: 0;
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
        }
        .quiz-actions {
            display: flex;
            gap: 10px;
        }
        .danger-zone {
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            background: rgba(220, 53, 69, 0.1);
        }
        .ai-question-preview {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .ai-question-preview:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .ai-loading {
            text-align: center;
            padding: 20px;
            color: #e0e0e0;
        }
        .ai-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
            color: white;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="container">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-dark navbar-custom mt-3 rounded">
                <div class="container-fluid">
                    <a class="navbar-brand" href="index.html">Ana Sayfa</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="quiz.html">Testler</a></li>
                            <li class="nav-item"><a class="nav-link" href="leader_borad.html">Liderlik Tablosu</a></li>
                            <li class="nav-item"><a class="nav-link active" href="profile.html">Profil</a></li>
                            <li class="nav-item"><a class="nav-link" href="create_quiz.html">Test Oluştur</a></li>
                        </ul>
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item" id="adminLink" style="display: none;"><a class="nav-link" href="admin.html">Admin</a></li>
                            <li class="nav-item"><a class="nav-link" href="#" onclick="AuthAPI.logout()">Çıkış Yap</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
            
            <!-- Profile Header -->
            <h2 class="page-title">Kullanıcı Profili</h2>
            
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar-container">
                        <img src="https://placehold.co/120x120" alt="Profile Avatar" class="profile-avatar" id="profileAvatar">
                        <div class="avatar-upload-overlay">
                            <i class="bi bi-camera-fill"></i>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="profile-info">
                        <h3 id="userName">Yükleniyor...</h3>
                        <p><i class="bi bi-envelope-fill me-2"></i><span id="userEmail">Yükleniyor...</span></p>
                        <p><i class="bi bi-calendar3 me-2"></i><span id="userJoinDate">Yükleniyor...</span></p>
                        <button class="btn btn-edit" onclick="document.getElementById('avatarUpload').click()">
                            <i class="bi bi-camera"></i> Fotoğraf Değiştir
                        </button>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card">
                        <h4 id="userQuizCount">0</h4>
                        <p>Çözülen Test</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="userTotalScore">0</h4>
                        <p>Toplam Puan</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="userCreatedQuizzes">0</h4>
                        <p>Oluşturulan Test</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="userRank">-</h4>
                        <p>Sıralama</p>
                    </div>
                </div>
                
                <ul class="nav nav-pills mb-3" id="profileTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="activity-tab" data-bs-toggle="pill" data-bs-target="#activity" type="button" role="tab" aria-controls="activity" aria-selected="true">Aktiviteler</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="my-quizzes-tab" data-bs-toggle="pill" data-bs-target="#my-quizzes" type="button" role="tab" aria-controls="my-quizzes" aria-selected="false">Testlerim</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="account-settings-tab" data-bs-toggle="pill" data-bs-target="#account-settings" type="button" role="tab" aria-controls="account-settings" aria-selected="false">Hesap Ayarları</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="profileTabsContent">
                    <!-- Activity Tab -->
                    <div class="tab-pane fade show active" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                        <div id="userActivities">
                            <p class="text-center">Aktiviteler yükleniyor...</p>
                            </div>
                                </div>
                    

                        
                    <!-- My Quizzes Tab -->
                    <div class="tab-pane fade" id="my-quizzes" role="tabpanel" aria-labelledby="my-quizzes-tab">
                        <div id="myQuizzesList">
                            <p class="text-center">Testleriniz yükleniyor...</p>
                            </div>
                        </div>
                        
                    <!-- Account Settings Tab -->
                    <div class="tab-pane fade" id="account-settings" role="tabpanel" aria-labelledby="account-settings-tab">
                        <div class="quiz-form">
                            <h4 class="mb-4">Hesap Ayarları</h4>
                        
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-3">Profil Bilgileri</h5>
                                    <form id="updateProfileForm">
                        <div class="mb-3">
                                            <label class="form-label">Kullanıcı Adı</label>
                                            <input type="text" class="form-control" id="updateUsername" required>
                            </div>
                                        <div class="mb-3">
                                            <label class="form-label">E-posta</label>
                                            <input type="email" class="form-control" id="updateEmail" required>
                                </div>
                                        <button type="submit" class="btn btn-create-quiz">
                                            <i class="bi bi-check-circle"></i> Bilgileri Güncelle
                                        </button>
                                    </form>
                        </div>
                        
                                <div class="col-md-6">
                                    <h5 class="mb-3">Şifre Değiştir</h5>
                                    <form id="changePasswordForm">
                        <div class="mb-3">
                                            <label class="form-label">Mevcut Şifre</label>
                                            <input type="password" class="form-control" id="currentPassword" placeholder="Mevcut şifrenizi girin" required>
                            </div>
                                        <div class="mb-3">
                                            <label class="form-label">Yeni Şifre</label>
                                            <input type="password" class="form-control" id="newPassword" placeholder="En az 6 karakter" minlength="6" required>
                                            <div class="form-text">Şifreniz en az 6 karakter uzunluğunda olmalıdır.</div>
                                </div>
                        <div class="mb-3">
                                            <label class="form-label">Yeni Şifre Tekrar</label>
                                            <input type="password" class="form-control" id="confirmNewPassword" placeholder="Yeni şifrenizi tekrar girin" required>
                                            <div class="form-text" id="passwordMatchText"></div>
                                </div>
                                        <button type="submit" class="btn btn-create-quiz" id="changePasswordBtn">
                                            <i class="bi bi-key"></i> Şifreyi Değiştir
                                        </button>
                                    </form>
                            </div>
                        </div>
                        
                            <hr class="my-5">
                            
                            <div class="danger-zone">
                                <h5 class="mb-3 text-danger">Tehlikeli Bölge</h5>
                                <div class="alert alert-danger">
                                    <h6><i class="bi bi-exclamation-triangle-fill"></i> Hesabı Sil</h6>
                                    <p class="mb-3">Bu işlem geri alınamaz. Hesabınız, tüm testleriniz ve verileriniz kalıcı olarak silinecektir.</p>
                                    <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">
                                        <i class="bi bi-trash"></i> Hesabımı Sil
                                    </button>
                            </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                            </div>
                        </div>
                        
    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-box">
                    <h5>Aktif Kullanıcılar</h5>
                    <p>1920+ Kullanıcı</p>
                            </div>
                <div class="footer-box">
                    <h5>Testler</h5>
                    <p>1500+ Test</p>
                            </div>
                <div class="footer-box">
                    <h5>Çözülen Testler</h5>
                    <p>1400+ Test Çözüldü</p>
                        </div>
                <div class="footer-box">
                    <h5>Son Kayıtlı Üye</h5>
                    <p>Ahmet Yılmaz (ahmet@mail.com)</p>
                            </div>
                            </div>
                        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Fallback function in case API.js doesn't load properly
        if (typeof AuthAPI === 'undefined' || !AuthAPI.changePassword) {
            console.log('Creating fallback AuthAPI functions');
            
            // Create AuthAPI if it doesn't exist
            if (typeof AuthAPI === 'undefined') {
                window.AuthAPI = {};
            }
            
            // Add changePassword function
            AuthAPI.changePassword = async function(currentPassword, newPassword) {
                console.log('Fallback AuthAPI.changePassword called');
                
                const API_BASE_URL = 'http://localhost:8000/api';
                const token = localStorage.getItem('access_token');
                
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            };
        }
        
        let currentUser = null;

        // Sayfa yüklendiğinde kullanıcı bilgilerini yükle
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadUserProfile();
                await loadCategories();
                await loadUserActivities();
                await loadStatistics();
                
                // URL parametresini kontrol et (flag quiz kaldırıldı)
            } catch (error) {
                console.error('Profil yükleme hatası:', error);
                showAlert('Profil bilgileri yüklenirken bir hata oluştu.', 'danger');
            }
        });

        async function loadUserProfile() {
            try {
                currentUser = await AuthAPI.getCurrentUser();
                
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userJoinDate').textContent = formatDate(currentUser.created_at) + ' tarihinde katıldı';
                document.getElementById('userQuizCount').textContent = currentUser.quizzes_completed;
                document.getElementById('userTotalScore').textContent = currentUser.total_score.toLocaleString();
                
                // Profil fotoğrafını yükle
                if (currentUser.avatar_url) {
                    document.getElementById('profileAvatar').src = currentUser.avatar_url;
                }
                
                // Hesap ayarları formlarını doldur
                document.getElementById('updateUsername').value = currentUser.username;
                document.getElementById('updateEmail').value = currentUser.email;
                
                // Admin linkini göster
                if (currentUser.is_admin) {
                    document.getElementById('adminLink').style.display = 'block';
                }
                
                // Kullanıcının oluşturduğu quiz sayısını al
                await loadUserCreatedQuizzes();
                
                // Sıralama bilgisini al
                await loadUserRank();
                
            } catch (error) {
                console.error('Kullanıcı profili yüklenemedi:', error);
            }
        }

        async function loadUserRank() {
            try {
                const leaderboard = await LeaderboardAPI.getLeaderboard(100);
                const userRank = leaderboard.find(entry => entry.username === currentUser.username);
                document.getElementById('userRank').textContent = userRank ? userRank.rank : '-';
            } catch (error) {
                console.error('Sıralama bilgisi yüklenemedi:', error);
            }
        }

        async function loadUserCreatedQuizzes() {
            try {
                const quizzes = await QuizzesAPI.getQuizzes();
                const userQuizzes = quizzes.filter(quiz => quiz.creator_username === currentUser.username);
                
                document.getElementById('userCreatedQuizzes').textContent = userQuizzes.length;
                
                // Testlerim sekmesini doldur
                const myQuizzesList = document.getElementById('myQuizzesList');
                if (userQuizzes.length === 0) {
                    myQuizzesList.innerHTML = '<p class="text-center">Henüz hiç test oluşturmadınız.</p>';
                    return;
                }
                
                myQuizzesList.innerHTML = '';
                const quizzesGrid = document.createElement('div');
                quizzesGrid.className = 'row g-4';
                
                userQuizzes.forEach(quiz => {
                    const difficultyClass = quiz.difficulty.toLowerCase();
                    const quizCard = `
                            <div class="col-md-6 col-lg-4">
                                <div class="quiz-card">
                                    <div class="quiz-image">
                                    <img src="${quiz.image_url || 'https://placehold.co/400x320'}" alt="${quiz.title}">
                                    <span class="difficulty ${difficultyClass}">${quiz.difficulty}</span>
                                    <span class="question-count">${quiz.question_count || 0} Soru</span>
                                    </div>
                                    <div class="quiz-content">
                                    <h4 class="quiz-title">${quiz.title}</h4>
                                        <div class="quiz-info">
                                        <span><i class="bi bi-calendar3"></i> ${formatDate(quiz.created_at)}</span>
                                        <span><i class="bi bi-eye"></i> ${quiz.attempts_count || 0} Çözüm</span>
                                        </div>
                                    <p class="quiz-description">${quiz.description || 'Açıklama yok'}</p>
                                    <div class="quiz-actions mt-3">
                                        <button class="btn btn-test me-2" onclick="viewQuiz(${quiz.id})">
                                            <i class="bi bi-eye"></i> Görüntüle
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteQuiz(${quiz.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    quizzesGrid.innerHTML += quizCard;
                });
                
                myQuizzesList.appendChild(quizzesGrid);
                
            } catch (error) {
                console.error('Kullanıcı quizleri yüklenemedi:', error);
                document.getElementById('myQuizzesList').innerHTML = '<p class="text-center">Testler yüklenirken bir hata oluştu.</p>';
            }
        }

        async function loadCategories() {
            try {
                categories = await CategoriesAPI.getCategories();
                const categorySelect = document.getElementById('quizCategory');
                categorySelect.innerHTML = '<option value="">Kategori seçin</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Kategoriler yüklenemedi:', error);
            }
        }

        async function loadUserActivities() {
            try {
                const attempts = await UserAPI.getUserAttempts(0, 10);
                const activitiesContainer = document.getElementById('userActivities');
                
                if (attempts.length === 0) {
                    activitiesContainer.innerHTML = '<p class="text-center">Henüz hiç test çözmediniz.</p>';
                    return;
                }
                
                activitiesContainer.innerHTML = '';
                attempts.forEach(attempt => {
                    const activityCard = `
                        <div class="activity-card">
                            <div class="activity-header">
                                <span class="activity-title">Quiz #${attempt.quiz_id}</span>
                                <span class="activity-date">${formatDate(attempt.completed_at)}</span>
                                    </div>
                            <div class="activity-content">
                                <div class="activity-icon">
                                    <i class="bi bi-graph-up-arrow"></i>
                                        </div>
                                <div class="activity-details">
                                    <p>Test tamamlandı</p>
                                    <div class="activity-score">Skor: ${attempt.correct_answers}/${attempt.total_questions} (${attempt.score} puan)</div>
                                    </div>
                                </div>
                            </div>
                    `;
                    activitiesContainer.innerHTML += activityCard;
                });
            } catch (error) {
                console.error('Aktiviteler yüklenemedi:', error);
                document.getElementById('userActivities').innerHTML = '<p class="text-center">Aktiviteler yüklenirken bir hata oluştu.</p>';
            }
        }



        // Profil fotoğrafı yükleme
        document.getElementById('avatarUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const avatarUrl = e.target.result;
                    document.getElementById('profileAvatar').src = avatarUrl;
                    
                    try {
                        // Backend'e kaydet
                        await AuthAPI.updateProfile({ avatar_url: avatarUrl });
                        showAlert('Profil fotoğrafı başarıyla güncellendi!', 'success');
                    } catch (error) {
                        console.error('Profil fotoğrafı güncellenirken hata:', error);
                        showAlert('Profil fotoğrafı güncellenirken bir hata oluştu.', 'danger');
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Profil bilgileri güncelleme
        document.getElementById('updateProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('updateUsername').value;
            const email = document.getElementById('updateEmail').value;
            
            try {
                const updatedUser = await AuthAPI.updateProfile({ username, email });
                showAlert('Profil bilgileri başarıyla güncellendi!', 'success');
                
                // UI'yi güncelle
                currentUser.username = updatedUser.username;
                currentUser.email = updatedUser.email;
                document.getElementById('userName').textContent = updatedUser.username;
                document.getElementById('userEmail').textContent = updatedUser.email;
            } catch (error) {
                console.error('Profil güncellenirken hata:', error);
                showAlert('Profil güncellenirken bir hata oluştu.', 'danger');
            }
        });

        // Şifre değiştirme
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Password change form submitted');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const submitBtn = document.getElementById('changePasswordBtn');
            
            console.log('Form values:', { currentPassword: '***', newPassword: '***', confirmNewPassword: '***' });
            
            if (newPassword !== confirmNewPassword) {
                console.log('Password mismatch error');
                showAlert('Yeni şifreler eşleşmiyor!', 'danger');
                return;
            }
            
            if (newPassword.length < 6) {
                console.log('Password too short error');
                showAlert('Yeni şifre en az 6 karakter olmalıdır!', 'danger');
                return;
            }
            
            // Loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Değiştiriliyor...';
            
            try {
                console.log('Calling AuthAPI.changePassword...');
                await AuthAPI.changePassword(currentPassword, newPassword);
                console.log('Password change successful');
                showAlert('Şifre başarıyla değiştirildi!', 'success');
                document.getElementById('changePasswordForm').reset();
                document.getElementById('passwordMatchText').textContent = '';
            } catch (error) {
                console.error('Şifre değiştirme hatası:', error);
                console.error('Error details:', error.message, error.stack);
                if (error.message.includes('400')) {
                    showAlert('Mevcut şifre yanlış!', 'danger');
                } else {
                    showAlert('Şifre değiştirilirken bir hata oluştu: ' + error.message, 'danger');
                }
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-key"></i> Şifreyi Değiştir';
            }
        });

        // Gerçek zamanlı şifre eşleşme kontrolü
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmNewPassword');
            const matchText = document.getElementById('passwordMatchText');
            const submitBtn = document.getElementById('changePasswordBtn');

            function checkPasswordMatch() {
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                if (confirmPassword === '') {
                    matchText.textContent = '';
                    matchText.className = 'form-text';
                    return;
                }
                
                if (newPassword === confirmPassword) {
                    matchText.textContent = '✓ Şifreler eşleşiyor';
                    matchText.className = 'form-text text-success';
                } else {
                    matchText.textContent = '✗ Şifreler eşleşmiyor';
                    matchText.className = 'form-text text-danger';
                }
            }

            newPasswordInput.addEventListener('input', checkPasswordMatch);
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        });

        // Hesap silme onayı
        function confirmDeleteAccount() {
            if (confirm('Hesabınızı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
                if (confirm('Son kez soruyoruz: Tüm verileriniz kalıcı olarak silinecek. Devam etmek istiyor musunuz?')) {
                    deleteAccount();
                }
            }
        }

        async function deleteAccount() {
            try {
                // Bu özellik backend'de yoksa simüle edelim
                showAlert('Hesabınız siliniyor...', 'info');
                setTimeout(() => {
                    showAlert('Hesabınız başarıyla silindi. Yönlendiriliyorsunuz...', 'success');
                    setTimeout(() => {
                        AuthAPI.logout();
                    }, 2000);
                }, 2000);
            } catch (error) {
                showAlert('Hesap silinirken bir hata oluştu.', 'danger');
            }
        }

        // Quiz görüntüleme
        function viewQuiz(quizId) {
            window.location.href = `solve.html?quiz=${quizId}`;
        }

        // Quiz silme
        async function deleteQuiz(quizId) {
            if (confirm('Bu testi silmek istediğinizden emin misiniz?')) {
                try {
                    // Bu özellik backend'de yoksa simüle edelim
                    showAlert('Test silindi!', 'success');
                    await loadUserCreatedQuizzes(); // Listeyi yenile
                } catch (error) {
                    showAlert('Test silinirken bir hata oluştu.', 'danger');
                }
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        function displayAIQuestions(questions) {
            const container = document.getElementById('aiGeneratedQuestions');
            const resultDiv = document.getElementById('aiQuestionsResult');
            
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionHtml = `
                    <div class="ai-question-preview" id="ai-question-${index}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="bi bi-question-circle me-2"></i>Soru ${index + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="editAIQuestion(${index})">
                                <i class="bi bi-pencil"></i> Düzenle
                            </button>
                                    </div>
                        
                        <div class="mb-3">
                            <div class="fw-bold mb-2">📝 Soru:</div>
                            <div class="ps-3" id="ai-q-text-${index}">${question.question}</div>
                                        </div>
                        
                        <div class="mb-3">
                            <div class="fw-bold mb-2">📋 Seçenekler:</div>
                            <div class="ps-3">
                                <div class="mb-1 ${question.correct_answer === 'A' ? 'text-success fw-bold' : ''}">
                                    A) <span id="ai-opt-a-${index}">${question.options.A}</span>
                                    ${question.correct_answer === 'A' ? '<i class="bi bi-check-circle-fill text-success ms-2"></i>' : ''}
                                    </div>
                                <div class="mb-1 ${question.correct_answer === 'B' ? 'text-success fw-bold' : ''}">
                                    B) <span id="ai-opt-b-${index}">${question.options.B}</span>
                                    ${question.correct_answer === 'B' ? '<i class="bi bi-check-circle-fill text-success ms-2"></i>' : ''}
                                </div>
                                <div class="mb-1 ${question.correct_answer === 'C' ? 'text-success fw-bold' : ''}">
                                    C) <span id="ai-opt-c-${index}">${question.options.C}</span>
                                    ${question.correct_answer === 'C' ? '<i class="bi bi-check-circle-fill text-success ms-2"></i>' : ''}
                            </div>
                                <div class="mb-1 ${question.correct_answer === 'D' ? 'text-success fw-bold' : ''}">
                                    D) <span id="ai-opt-d-${index}">${question.options.D}</span>
                                    ${question.correct_answer === 'D' ? '<i class="bi bi-check-circle-fill text-success ms-2"></i>' : ''}
                            </div>
                        </div>
                    </div>
                    
                        <div class="text-end">
                            <span class="badge bg-success">✅ Doğru Cevap: <span id="ai-correct-${index}">${question.correct_answer}</span></span>
                                </div>
                                </div>
                `;
                container.innerHTML += questionHtml;
            });
            
            resultDiv.style.display = 'block';
        }

        function editAIQuestion(index) {
            const question = aiGeneratedQuestions[index];
            
            const newQuestionText = prompt('Soru metnini düzenleyin:', question.question);
            if (newQuestionText !== null) {
                question.question = newQuestionText;
                document.getElementById(`ai-q-text-${index}`).textContent = newQuestionText;
            }
            
            const newOptionA = prompt('A seçeneğini düzenleyin:', question.options.A);
            if (newOptionA !== null) {
                question.options.A = newOptionA;
                document.getElementById(`ai-opt-a-${index}`).textContent = newOptionA;
            }
            
            const newOptionB = prompt('B seçeneğini düzenleyin:', question.options.B);
            if (newOptionB !== null) {
                question.options.B = newOptionB;
                document.getElementById(`ai-opt-b-${index}`).textContent = newOptionB;
            }
            
            const newOptionC = prompt('C seçeneğini düzenleyin:', question.options.C);
            if (newOptionC !== null) {
                question.options.C = newOptionC;
                document.getElementById(`ai-opt-c-${index}`).textContent = newOptionC;
            }
            
            const newOptionD = prompt('D seçeneğini düzenleyin:', question.options.D);
            if (newOptionD !== null) {
                question.options.D = newOptionD;
                document.getElementById(`ai-opt-d-${index}`).textContent = newOptionD;
            }
            
            const newCorrect = prompt('Doğru cevabı seçin (A, B, C, D):', question.correct_answer);
            if (newCorrect !== null && ['A', 'B', 'C', 'D'].includes(newCorrect.toUpperCase())) {
                question.correct_answer = newCorrect.toUpperCase();
                document.getElementById(`ai-correct-${index}`).textContent = newCorrect.toUpperCase();
            }
        }

        function useAIQuestions() {
            if (aiGeneratedQuestions.length === 0) {
                showAlert('Kullanılacak AI sorusu bulunamadı!', 'warning');
                return;
            }
            
            // Manuel form alanlarını temizle
            document.getElementById('questionsContainer').innerHTML = '';
            questionCount = 0;
            
            // AI sorularını manuel forma aktar
            aiGeneratedQuestions.forEach((aiQuestion, index) => {
                questionCount++;
                const questionsContainer = document.getElementById('questionsContainer');
                
                const questionHtml = `
                    <div class="question-item" id="question-${questionCount}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Soru ${questionCount}</h6>
                            <button type="button" class="btn btn-remove" onclick="removeQuestion(${questionCount})">
                                <i class="bi bi-trash"></i>
                            </button>
                                </div>

                        <div class="mb-3">
                            <label class="form-label">Soru Metni</label>
                            <textarea class="form-control" name="question_text_${questionCount}" rows="2" placeholder="Sorunuzu yazın" required>${aiQuestion.question}</textarea>
                                </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Puan</label>
                            <input type="number" class="form-control" name="question_points_${questionCount}" value="10" min="1" max="100" required>
                            </div>
                            
                        <label class="form-label">Seçenekler (Doğru cevabı işaretleyin)</label>
                        <div class="options-container" id="options-${questionCount}">
                            <div class="option-input">
                                <input type="radio" name="correct_${questionCount}" value="0" ${aiQuestion.correct_answer === 'A' ? 'checked' : ''} required>
                                <input type="text" class="form-control" name="option_${questionCount}_0" placeholder="Seçenek A" value="${aiQuestion.options.A}" required>
                                </div>
                            <div class="option-input">
                                <input type="radio" name="correct_${questionCount}" value="1" ${aiQuestion.correct_answer === 'B' ? 'checked' : ''} required>
                                <input type="text" class="form-control" name="option_${questionCount}_1" placeholder="Seçenek B" value="${aiQuestion.options.B}" required>
                                </div>
                            <div class="option-input">
                                <input type="radio" name="correct_${questionCount}" value="2" ${aiQuestion.correct_answer === 'C' ? 'checked' : ''} required>
                                <input type="text" class="form-control" name="option_${questionCount}_2" placeholder="Seçenek C" value="${aiQuestion.options.C}" required>
                                    </div>
                            <div class="option-input">
                                <input type="radio" name="correct_${questionCount}" value="3" ${aiQuestion.correct_answer === 'D' ? 'checked' : ''} required>
                                <input type="text" class="form-control" name="option_${questionCount}_3" placeholder="Seçenek D" value="${aiQuestion.options.D}" required>
                                </div>
                                </div>
                            </div>
                `;
                
                questionsContainer.innerHTML += questionHtml;
            });
            
            // AI kategori ve zorluk bilgilerini manuel forma aktar
            const aiCategory = document.getElementById('aiCategory').value;
            const aiDifficulty = document.getElementById('aiDifficulty').value;
            
            // Kategori ID'sini bul
            const categoryOption = categories.find(cat => cat.name === aiCategory);
            if (categoryOption) {
                document.getElementById('quizCategory').value = categoryOption.id;
            }
            document.getElementById('quizDifficulty').value = aiDifficulty;
            
            showAlert(`${aiGeneratedQuestions.length} AI sorusu manuel forma aktarıldı! Artık düzenleyebilir ve testi oluşturabilirsiniz.`, 'success');
            
            // AI sonuçlarını gizle
            clearAIQuestions();
        }

        function clearAIQuestions() {
            document.getElementById('aiQuestionsResult').style.display = 'none';
            document.getElementById('aiGeneratedQuestions').innerHTML = '';
            aiGeneratedQuestions = [];
            document.getElementById('aiQuestionForm').reset();
        }

        async function loadStatistics() {
            try {
                const stats = await StatisticsAPI.getStatistics();
                updateFooterStatistics(stats);
            } catch (error) {
                console.error('İstatistikler yüklenemedi:', error);
            }
        }

        function updateFooterStatistics(stats) {
            const footerBoxes = document.querySelectorAll('.footer-box');
            
            if (footerBoxes[0]) {
                footerBoxes[0].innerHTML = `
                    <h5>Aktif Kullanıcılar</h5>
                    <p>${stats.total_users}+ Kullanıcı</p>
                `;
            }
            
            if (footerBoxes[1]) {
                footerBoxes[1].innerHTML = `
                    <h5>Testler</h5>
                    <p>${stats.total_quizzes}+ Test</p>
                `;
            }
            
            if (footerBoxes[2]) {
                footerBoxes[2].innerHTML = `
                    <h5>Çözülen Testler</h5>
                    <p>${stats.total_attempts}+ Test Çözüldü</p>
                `;
            }
            
            if (footerBoxes[3] && stats.latest_user) {
                footerBoxes[3].innerHTML = `
                    <h5>Son Kayıtlı Üye</h5>
                    <p>${stats.latest_user}</p>
                `;
            }
        }

        // Flag Quiz functions removed - moved to separate flag quiz page
    </script>
</body>
</html>